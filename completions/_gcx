#compdef gcx

# gcx zsh completion

_gcx_get_orgs() {
    local config_file="$HOME/.config/gcx/config.yaml"
    if [[ -f "$config_file" ]] && (( $+commands[yq] )); then
        yq '.organizations | keys | .[]' "$config_file" 2>/dev/null
    fi
}

_gcx_get_identities() {
    local org="$1"
    local config_file="$HOME/.config/gcx/config.yaml"
    if [[ -f "$config_file" ]] && (( $+commands[yq] )); then
        yq ".organizations.${org}.identities | keys | .[]" "$config_file" 2>/dev/null
    fi
}

_gcx_adc() {
    local -a adc_commands
    adc_commands=(
        'login:Fresh login (refresh ADC)'
        'l:Fresh login (refresh ADC)'
        'switch:Switch between saved credentials'
        's:Switch between saved credentials'
        'save:Save current ADC'
        'help:Show help'
    )
    _describe -t commands 'adc command' adc_commands
}

_gcx_vm() {
    local -a vm_commands
    vm_commands=(
        'list:List all VMs'
        'ls:List all VMs'
        'ssh:SSH to VM'
        'start:Start VM'
        'stop:Stop VM'
        'help:Show help'
    )
    _describe -t commands 'vm command' vm_commands
}

_gcx_run() {
    local -a run_commands
    run_commands=(
        'list:List all services'
        'ls:List all services'
        'logs:View service logs'
        'open:Open service URL'
        'help:Show help'
    )
    _describe -t commands 'run command' run_commands
}

_gcx_setup() {
    local -a setup_commands
    setup_commands=(
        'init:Initialize configuration'
        'add-org:Add new organization'
        'add-id:Add identity to org'
        'export:Export template for sharing'
        'import:Import template'
        'list:Show current configuration'
        'show:Show current configuration'
        'edit:Edit config file'
        'deps:Check dependencies'
        'help:Show help'
    )
    _describe -t commands 'setup command' setup_commands
}

_gcx() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    _arguments -C \
        '1: :->command' \
        '2: :->subcommand' \
        '*: :->args'

    case $state in
        command)
            local -a commands
            commands=(
                'status:Show current context'
                's:Show current context'
                'project:Quick switch project'
                'p:Quick switch project'
                'adc:ADC management'
                'vm:VM instance management'
                'run:Cloud Run management'
                'setup:Run setup wizard'
                'version:Show version'
                'help:Show help'
            )

            # Add organizations
            local -a orgs
            orgs=($(_gcx_get_orgs))
            for org in $orgs; do
                commands+=("${org}:Switch to ${org}")
            done

            _describe -t commands 'gcx command' commands
            ;;
        subcommand)
            case $line[1] in
                adc)
                    _gcx_adc
                    ;;
                vm)
                    _gcx_vm
                    ;;
                run)
                    _gcx_run
                    ;;
                setup)
                    _gcx_setup
                    ;;
                *)
                    # Check if it's an org, offer identities
                    local -a orgs
                    orgs=($(_gcx_get_orgs))
                    if (( ${orgs[(I)${line[1]}]} )); then
                        local -a identities
                        identities=($(_gcx_get_identities "${line[1]}"))
                        _describe -t identities 'identity' identities
                    fi
                    ;;
            esac
            ;;
    esac
}

_gcx "$@"
